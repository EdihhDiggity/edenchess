<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale:1.0">
    <title>Chess Opening Practice</title>

    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>



    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">


    <style>
        .pixelify-sans-font {
            font-family: "Pixelify Sans", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
        }

        body {
            text-align: center;
            font-family: sans-serif;
            background-color: black;
            color: white;
        }

        #board {
            width: 400px;
            margin: auto;
            border: 1px solid white;
            overflow: hidden;
        }



        .edihh {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr;
            width: 400px;
            margin: auto;
        }

        .dialog {
            margin: 20px;
            text-align: left;
            text-indent: 20px;
            font-family: "Pixelify Sans", sans-serif;
            color: white;
        }

        @keyframes float {
            0% {
                transform: translatey(0px);
            }

            50% {
                transform: translatey(-10px);
            }

            100% {
                transform: translatey(0px);
            }
        }

        .pic {
            animation: float 4s ease-in-out infinite;
        }

        @media (max-width: 480px) {
            #board {
                width: 100%;
                margin: auto;
            }

            .edihh {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <h3>Chess Opening Practice</h3>
    <div id="board"></div>

    <p id="status"></p>
    <button onclick="nextPuzzle()">Next Puzzle</button>
    <br>

    <div class="edihh">
        <div class="pic">
            <img src="{{ url_for('static', filename='edihh/img/edihh.png') }}" alt="Edihh"
                style="object-fit: cover; width: 100%;">
        </div>
        <div class="dialog" id="dialog">
            . . .
        </div>
    </div>


    <script>
        var puzzles = {{ puzzles| tojson | safe }} || [];
        var current = 0;
        var game = new Chess();
        var solutionIndex = 0;

        function loadPuzzle(i) {
            if (puzzles.length === 0) return;
            var p = puzzles[i];
            game.load(p.fen);
            board.position(p.fen);
            solutionIndex = 0;

            // Flip board depending on whose turn it is
            board.orientation(p.turn === "b" ? "black" : "white");

            document.getElementById("status").innerText =
                "Line " + (i + 1) + " | " +
                (p.turn === "w" ? "White" : "Black") + " to move";

            //dialog
            if (p.dialog) {
                document.getElementById("dialog").innerText = p.dialog;
            } else document.getElementById("dialog").innerText = ". . .";

            // If puzzle starts with computer move
            if (game.turn() !== p.turn) {
                autoPlay();
            }
        }

        function nextPuzzle() {
            if (puzzles.length === 0) return;

            var next;
            do {
                next = Math.floor(Math.random() * puzzles.length);
            } while (next === current && puzzles.length > 1); // avoid same puzzle twice

            current = next;
            loadPuzzle(current);
        }


        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;

            var turn = game.turn();
            var p = puzzles[current];

            // Prevent moving opponentâ€™s pieces
            if ((turn === 'w' && piece.search(/^b/) !== -1) ||
                (turn === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop(source, target) {
            var move = game.move({
                from: source,
                to: target,
                promotion: "q"
            });

            if (move === null) return 'snapback';

            var expectedMove = puzzles[current].solution[solutionIndex];
            if (move.san === expectedMove) {
                solutionIndex++;
                if (solutionIndex >= puzzles[current].solution.length) {
                    document.getElementById("status").innerText = "Correct solution!";
                } else {
                    document.getElementById("status").innerText = "Good! Opponent to move...";
                    setTimeout(autoPlay, 500); // computer reply
                }
            } else {
                document.getElementById("status").innerText = "Wrong move! Try again.";
                game.undo();
                return 'snapback';
            }
        }

        function autoPlay() {
            var p = puzzles[current];
            if (solutionIndex >= p.solution.length) return;

            var expectedMove = p.solution[solutionIndex];
            var move = game.move(expectedMove);
            if (move) {
                board.position(game.fen());
                solutionIndex++;
                document.getElementById("status").innerText = "Your move...";
            }
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        var board = Chessboard('board', {
            draggable: true,
            position: 'start',
            pieceTheme: "{{ url_for('static', filename='chessboard/img/chesspieces/wikipedia') }}/" + "{piece}.png",
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        });

        loadPuzzle(current);


        window.addEventListener("resize", function () {
            board.resize();
        });
    </script>



</body>

</html>
